<script setup>
</script>

<template>
    <div style="margin: 30px;">
        <h4>Critical Vulnerabilities</h4>
        <table class="ui striped table">
            <thead>
                <tr>
                    <th>CVE</th>
                    <th>CVSS</th>
                    <th>Number of assets</th>
                    <th>CVE Details</th>
                    <th>Create Remediation Task</th>
                    <th>Remediation Task</th>

                </tr>
            </thead>
            <tbody>
                <tr v-for="vul in vulnerabilities">
                    <td><a v-bind:href="'https://app.lansweeper.com/api-demo-data-site/security-insights/vulnerabilities/details/summary?cveId=' + vul.cve"
                            target="_blank">{{ vul.cve }}</a></td>
                    <td>{{ vul.riskScore }}</td>
                    <td v-on:click="modalOn(vul.assetData, false,vul.cve)"><span style="cursor:pointer">{{ vul.assetKeys.length
                    }}</span>
                    </td>
                    <td><a v-bind:href="'https://www.cvedetails.com/cve/' + vul.cve" target="_blank">link</a></td>
                    <td><button class="ui mini blue button" v-on:click="modalOn(vul.assetData, true,vul.cve)">Fix {{ vul.cve }}...</button></td>
                    <td v-bind:id="'td_'+vul.cve">
                        <a v-if="vul.hasOwnProperty('issue')" v-bind:href="vul.issue.self.match(/(?:[^:]+:\/\/)(?:www\.)*([.a-z0-9-]+)+/)[0]+'/browse/'+vul.issue.key" target='_blank'>{{vul.issue.key}}</a>
                    </td>
                </tr>

            </tbody>
        </table>
        <!--modal definition-->
        <div class="ui modal">
            <div class="header">Affected Assets by {{ modalCVE }}</div>
            <div v-if="fixIt" class="ui info message" style="margin:25px">
                <i class="close icon"></i>
                <div class="header">
                    Select Assets!
                </div>
                <p>
                    Please select all assets you want to include into remediation task.
                </p>
                
            </div>
            <div class="scrolling content">
                <table class="ui striped very compact table">
                    <thead>
                        <tr>
                            <th v-if="fixIt">Select</th>
                            <th>Asset Name</th>
                            <th>Asset Type</th>
                            <th>IP Address</th>
                           
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="asset in modalAssets">
                            <td v-if="fixIt"> <input type="checkbox" v-model="listofAssets[asset.key]" v-bind:name="asset.key"></td>
                            <td><a v-bind:href="'https://app.lansweeper.com/api-demo-data-site/asset/' + asset.key"
                                    target="_blank">{{ asset.assetBasicInfo.name }}</a></td>
                            <td>{{ asset.assetBasicInfo.type }}</td>
                            <td>{{ asset.assetBasicInfo.ipAddress }}</td>
                        </tr>

                    </tbody>
                </table>
                <button v-if="fixIt" class="fluid ui blue mini button" v-on:click="submit(modalCVE)">Create Remediation Task</button>
            </div>
        </div>
    </div>
</template>

<script>
export default {
    props: [],
    data() {
        return {
            vulnerabilities: [],
            modalAssets: [],
            fixIt: false,
            modalCVE:"",
            listofAssets:[],
            issue_id: [],
            loading: false,
            jira_issue: {}
        }
    },

    methods: {
        //get all data from the server
        loadList: function () {
            this.loading = true;
            axios({
                url: "/cves",
                method: 'get',
            }).then((result) => {
                this.vulnerabilities = result.data;
                this.loading = false;
            });
        },
        //open modal 
        modalOn: function (assetData, fixIt, modalCVE) {
            this.fixIt = fixIt;
            this.modalCVE=modalCVE;
            $('.ui.modal').modal('show');
            this.modalAssets = assetData;
        },
        //submit the selected assets to create jira ticket
        submit: function (cve){
            var issueData={
                "cve":cve,
                "assetKeys":[]
            }
            for (var i in this.listofAssets){
                issueData.assetKeys.push(i)
                
            }
            this.createJiraIssue(issueData)
        },
        //call server to create Jira Issue anf update the table with link to Jira
        createJiraIssue: function (data) {
            axios({
                url: "/ticket",
                method: 'post',
                data: data
            }).then((result) => {
                $('.ui.modal').modal('hide');
                var atlasianUrl=result.data.self.match(/(?:[^:]+:\/\/)(?:www\.)*([.a-z0-9-]+)+/);
                $('#td_'+data.cve).html("<a href='"+atlasianUrl[0]+"/browse/"+result.data.key+"' target='_blank'>"+result.data.key+"</a>");
            });
        }

    },
    mounted() {
        this.loadList()
    }
}
</script>

<style scoped></style>
